# Chapter 6: Web-Based Database Programming (Web 数据库编程)

## 1. PHP and Database (PHP 与数据库)
* **Persistence:** Web systems persist data permanently in databases like **MySQL/MariaDB** (full-featured) or **SQLite** (light-weight). (Web 系统通过数据库实现数据的永久持久化。)
* **MariaDB:** A community-developed fork of MySQL, used in XAMPP. (MySQL 的开源分支，XAMPP 默认使用。)
* **PDO (PHP Data Object):** A database access layer providing a uniform method of access to multiple databases. (PHP 数据对象：提供统一的跨数据库访问接口。)
    * **Advantages:** Object-oriented, supports multiple databases, and enhances security. (面向对象、支持多种数据库、安全性高。)

## 2. Connecting to Database via PDO (通过 PDO 连接数据库)
* **DSN (Data Source Name):** Contains the information required to connect to the database. (包含连接数据库所需的参数，如驱动、主机名、数据库名。)
    * *Example:* `$dsn = "mysql:host=localhost;dbname=my_db;charset=utf8mb4";`
* **PDO Constructor:** `$db = new PDO($dsn, $username, $password, $options);` (实例化 PDO 对象来建立连接。)
* **Error Handling:** Use `try...catch` blocks to handle `PDOException`. (使用 try...catch 捕获连接异常。)

## 3. Executing SQL Statements (执行 SQL 语句)
* **`query()`:** Used for SQL statements that return a result set (e.g., `SELECT`). (用于返回结果集的查询。)
* **`exec()`:** Used for SQL statements that do not return a result set (e.g., `INSERT`, `UPDATE`, `DELETE`). Returns the number of affected rows. (用于不返回结果集的语句，返回受影响的行数。)

## 4. Fetching Data (获取数据)
* **`fetch()`:** Fetches the next row from a result set. (获取结果集中的下一行。)
* **`fetchAll()`:** Returns an array containing all of the result set rows. (获取结果集中的所有行。)
* **Fetch Modes:**
    * `PDO::FETCH_ASSOC`: Returns an associative array (column names as keys). (返回以列名为键的关联数组。)
    * `PDO::FETCH_OBJ`: Returns an anonymous object with property names that correspond to column names. (返回属性名对应列名的匿名对象。)

## 5. Prepared Statements (预处理语句 - 重要安全机制)
* **Why use it?** To prevent **SQL Injection** and improve performance for repeated queries. (防止 SQL 注入攻击，并提高重复查询的效率。)
* **Workflow:**
    1. **Prepare:** Create a template with placeholders (`?` or `:name`). (准备 SQL 模板和占位符。)
    2. **Bind:** Attach values to the placeholders. (绑定实际参数值。)
    3. **Execute:** Run the statement. (执行语句。)
* **Methods:**
    * `$stmt = $db->prepare($sql);`
    * `$stmt->execute([':id' => $id]);`

## 6. CRUD Operations (增删改查操作)
* **INSERT:** Adding new records. Use `lastInsertId()` to get the ID of the last inserted row. (添加记录，可获取最后插入的 ID。)
* **UPDATE:** Modifying existing records. (修改现有记录。)
* **DELETE:** Removing records. (删除记录。)
* **Best Practice:** Always use **Prepared Statements** for any query involving user input. (任何涉及用户输入的查询务必使用预处理语句。)

## 7. Database Transactions (数据库事务)
* **ACID Properties:** Ensures reliability (Atomicity, Consistency, Isolation, Durability). (确保数据的原子性、一致性、隔离性和持久性。)
* **Workflow:**
    * `$db->beginTransaction();` (开始事务)
    * Execute multiple SQL statements.
    * `$db->commit();` (提交事务 - 保存更改)
    * `$db->rollBack();` (回滚事务 - 若出错则撤销所有操作)

## 8. Database Security Practices (数据库安全实践)
* **Prepared Statements:** Use them instead of mixing SQL with variables. (使用预处理语句而非拼接变量。)
* **Input Validation:** Validate and sanitize all user inputs. (验证并清理所有用户输入。)
* **Principle of Least Privilege:** Application should use accounts with minimum necessary permissions (e.g., avoid using 'root'). (最小权限原则：不使用 root 账号，仅授予必要权限。)
* **Data Masking:** Do not hardcode settings; store database credentials in a separate, secure file. (不要硬编码配置，将凭据存储在独立且安全的文件中。)
* **Administrative Security:** Change default ports and disable management tools (like PHPMyAdmin) when not in use. (更改默认端口，不使用时禁用管理工具。)
